<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Order Parser - Cita Rasa Indo v2.3 FIXED</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --bg-main: #0a0e17;
  --bg-card: #141824;
  --bg-card-hover: #1a1f2e;
  --primary: #ff6b6b;
  --secondary: #ffa726;
  --accent: #4ecdc4;
  --success: #51cf66;
  --warning: #ffd93d;
  --text-primary: #e9ecef;
  --text-secondary: #adb5bd;
  --text-muted: #6c757d;
  --border: #2d3748;
  --shadow: 0 4px 16px rgba(0,0,0,.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,.5);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #0a0e17 0%, #1a1f2e 100%);
  background-attachment: fixed;
  color: var(--text-primary);
  min-height: 100vh;
  padding: 12px;
  padding-bottom: 40px;
  -webkit-font-smoothing: antialiased;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

.header {
  background: var(--bg-card);
  padding: 20px 16px;
  border-radius: 16px;
  box-shadow: var(--shadow-lg);
  margin-bottom: 16px;
  text-align: center;
  border: 1px solid var(--border);
}

.header h1 {
  color: var(--text-primary);
  font-size: 1.5em;
  margin-bottom: 6px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  line-height: 1.2;
}

.header p {
  color: var(--text-secondary);
  font-size: 0.9em;
  line-height: 1.4;
}

.ai-badge {
  display: inline-block;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.75em;
  font-weight: 700;
  margin-top: 8px;
  box-shadow: 0 2px 8px rgba(102,126,234,0.3);
}

.card {
  background: var(--bg-card);
  padding: 16px;
  border-radius: 16px;
  box-shadow: var(--shadow-lg);
  margin-bottom: 16px;
  border: 1px solid var(--border);
}

.card h2 {
  color: var(--text-primary);
  font-size: 1.3em;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.input-area {
  width: 100%;
  min-height: 280px;
  padding: 14px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
  resize: vertical;
  background: var(--bg-main);
  color: var(--text-primary);
  line-height: 1.5;
}

.input-area:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(255,167,38,.2);
}

.input-area::placeholder {
  color: var(--text-muted);
}

.button-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 12px;
}

.btn {
  width: 100%;
  padding: 16px 20px;
  border: none;
  border-radius: 12px;
  font-size: 1em;
  font-weight: 700;
  cursor: pointer;
  transition: all .3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-height: 52px;
  -webkit-tap-highlight-color: transparent;
}

.btn:active {
  transform: scale(0.98);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: linear-gradient(135deg, var(--success), #45a049);
  color: white;
  box-shadow: 0 4px 16px rgba(81,207,102,0.3);
}

.btn-secondary {
  background: var(--bg-card-hover);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}

.btn-example {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  box-shadow: 0 4px 16px rgba(102,126,234,0.3);
}

.btn-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.btn-small {
  padding: 6px 12px;
  font-size: 0.85em;
  min-height: auto;
  border-radius: 8px;
}

.btn-delete {
  background: var(--primary);
  color: white;
  width: 32px;
  height: 32px;
  padding: 0;
  border-radius: 50%;
  font-size: 1.2em;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-delete:hover {
  background: #e74c3c;
  transform: scale(1.1);
}

.results-section {
  display: none;
}

.results-section.active {
  display: block;
}

.ingredient-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-top: 12px;
}

.ingredient-card {
  background: var(--bg-card-hover);
  padding: 14px 12px;
  border-radius: 12px;
  border: 2px solid var(--border);
  text-align: center;
  min-height: 120px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  transition: all .3s;
}

.ingredient-card:hover {
  border-color: var(--secondary);
  transform: translateY(-2px);
}

.ingredient-card.highlight {
  border-color: var(--secondary);
  background: linear-gradient(135deg, rgba(255,167,38,0.15), rgba(255,112,67,0.15));
  box-shadow: 0 0 20px rgba(255,167,38,0.2);
}

.ingredient-icon {
  font-size: 2.2em;
  margin-bottom: 6px;
}

.ingredient-name {
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 4px;
  font-size: 0.85em;
  line-height: 1.2;
}

.ingredient-qty {
  font-size: 1.6em;
  font-weight: 800;
  color: var(--secondary);
  line-height: 1;
}

.ingredient-unit {
  font-size: 0.8em;
  color: var(--text-secondary);
  margin-top: 4px;
}

.summary-card {
  background: linear-gradient(135deg, var(--primary), #e74c3c);
  color: white;
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 12px;
  box-shadow: 0 4px 20px rgba(255,107,107,0.3);
}

.summary-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 0.95em;
}

.summary-row:last-child {
  margin-bottom: 0;
  padding-top: 8px;
  border-top: 2px solid rgba(255,255,255,0.3);
  font-size: 1.15em;
  font-weight: 800;
}

.orders-list {
  margin-top: 12px;
  max-height: calc(100vh - 600px);
  min-height: 200px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.order-item {
  background: var(--bg-card-hover);
  padding: 14px;
  border-radius: 10px;
  margin-bottom: 10px;
  border: 2px solid var(--border);
  transition: all .3s;
  position: relative;
}

.order-item:hover {
  border-color: var(--secondary);
  transform: translateX(4px);
}

.order-item.merged {
  border-color: var(--accent);
  background: linear-gradient(135deg, rgba(78,205,196,0.1), rgba(78,205,196,0.05));
}

.order-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 6px;
  gap: 8px;
}

.order-name {
  font-weight: 700;
  color: var(--text-primary);
  font-size: 0.95em;
  flex: 1;
  line-height: 1.3;
}

.order-qty {
  font-weight: 800;
  color: var(--secondary);
  background: rgba(255,167,38,0.15);
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.9em;
  white-space: nowrap;
  border: 1px solid rgba(255,167,38,0.3);
}

.order-original {
  font-size: 0.8em;
  color: var(--text-muted);
  font-style: italic;
  padding: 6px 8px;
  background: rgba(255,255,255,0.03);
  border-radius: 6px;
  border-left: 3px solid var(--border);
  word-break: break-word;
  flex: 1;
}

.order-price {
  font-weight: 800;
  color: var(--success);
  font-size: 1.1em;
  white-space: nowrap;
  margin-left: 10px;
  background: rgba(81,207,102,0.15);
  padding: 4px 10px;
  border-radius: 8px;
  border: 1px solid rgba(81,207,102,0.3);
}

.order-controls {
  display: flex;
  gap: 8px;
  align-items: center;
  position: absolute;
  top: 10px;
  right: 10px;
}

.qty-spinner {
  display: flex;
  align-items: center;
  gap: 6px;
  background: rgba(255,167,38,0.1);
  padding: 4px 8px;
  border-radius: 20px;
  border: 1px solid rgba(255,167,38,0.3);
}

.qty-btn {
  background: var(--secondary);
  color: white;
  border: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1em;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .2s;
}

.qty-btn:hover {
  background: #ff9800;
  transform: scale(1.1);
}

.qty-btn:active {
  transform: scale(0.95);
}

.qty-display {
  font-weight: 700;
  color: var(--secondary);
  min-width: 20px;
  text-align: center;
}

.total-price-box {
  margin-top: 12px;
  padding: 20px;
  background: linear-gradient(135deg, var(--success) 0%, #45a049 100%);
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(81,207,102,0.4);
  text-align: center;
  border: 2px solid rgba(255,255,255,0.1);
  animation: pulseGlow 2s ease-in-out infinite;
}

@keyframes pulseGlow {
  0%, 100% {
    box-shadow: 0 8px 24px rgba(81,207,102,0.4);
  }
  50% {
    box-shadow: 0 8px 32px rgba(81,207,102,0.6);
  }
}

.total-price-label {
  font-size: 1em;
  color: rgba(255,255,255,0.9);
  margin-bottom: 8px;
  font-weight: 600;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.total-price-amount {
  font-size: 2.8em;
  color: white;
  font-weight: 900;
  line-height: 1;
  text-shadow: 0 4px 8px rgba(0,0,0,0.3);
  letter-spacing: -1px;
}

.confidence-badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 0.7em;
  font-weight: 700;
  margin-top: 4px;
}

.confidence-high {
  background: rgba(81,207,102,0.2);
  color: var(--success);
  border: 1px solid rgba(81,207,102,0.4);
}

.confidence-medium {
  background: rgba(255,217,61,0.2);
  color: var(--warning);
  border: 1px solid rgba(255,217,61,0.4);
}

.confidence-low {
  background: rgba(255,107,107,0.2);
  color: var(--primary);
  border: 1px solid rgba(255,107,107,0.4);
}

.merged-badge {
  display: inline-block;
  background: linear-gradient(135deg, var(--accent), #3ba89e);
  color: white;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.7em;
  font-weight: 700;
  margin-left: 6px;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 3em;
  margin-bottom: 12px;
  opacity: 0.5;
}

.empty-state p {
  font-size: 0.9em;
  line-height: 1.4;
}

.alert {
  padding: 14px 16px;
  border-radius: 12px;
  margin-top: 12px;
  display: none;
  font-weight: 600;
  font-size: 0.9em;
  line-height: 1.4;
  border: 1px solid;
}

.alert.show {
  display: block;
}

.alert-success {
  background: rgba(81,207,102,0.15);
  border-color: var(--success);
  color: var(--success);
}

.alert-warning {
  background: rgba(255,217,61,0.15);
  border-color: var(--warning);
  color: var(--warning);
}

.alert-info {
  background: rgba(78,205,196,0.15);
  border-color: var(--accent);
  color: var(--accent);
}

.alert-error {
  background: rgba(255,107,107,0.15);
  border-color: var(--primary);
  color: var(--primary);
}

.processing {
  text-align: center;
  padding: 30px 20px;
  color: var(--text-primary);
  font-weight: 600;
}

.processing-icon {
  font-size: 2.5em;
  animation: spin 1s linear infinite;
  margin-bottom: 10px;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.toggle-container {
  margin-top: 14px;
  padding: 12px;
  background: rgba(78,205,196,0.1);
  border: 2px solid var(--accent);
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: all .3s;
}

.toggle-container:hover {
  background: rgba(78,205,196,0.15);
  border-color: #3ba89e;
}

.toggle-container input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--accent);
}

.toggle-container label {
  flex: 1;
  font-size: 0.9em;
  color: var(--text-primary);
  font-weight: 600;
  cursor: pointer;
  user-select: none;
}

.notes-section {
  margin-top: 16px;
  padding: 16px;
  background: rgba(255,217,61,0.1);
  border: 2px solid var(--warning);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(255,217,61,0.2);
}

.notes-section h3 {
  color: var(--warning);
  font-size: 1.15em;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.notes-section ul {
  list-style: none;
  padding: 0;
}

.notes-section li {
  padding: 6px 0;
  color: var(--text-secondary);
  font-size: 0.9em;
  line-height: 1.4;
  padding-left: 20px;
  position: relative;
}

.notes-section li:before {
  content: "‚ö†Ô∏è";
  position: absolute;
  left: 0;
  font-size: 0.9em;
}

#undetectedList li:before {
  content: "üö®";
}

.chicken-notes {
  margin-top: 12px;
  padding: 14px 16px;
  background: linear-gradient(135deg, rgba(255,167,38,0.15), rgba(255,112,67,0.15));
  border: 2px solid var(--secondary);
  border-radius: 12px;
  font-size: 0.95em;
  color: var(--text-primary);
  box-shadow: 0 4px 12px rgba(255,167,38,0.2);
}

.chicken-notes strong {
  font-size: 1.1em;
  display: block;
  margin-bottom: 6px;
  color: var(--secondary);
}

.grand-total-card {
  margin-top: 16px;
  padding: 24px;
  background: linear-gradient(135deg, var(--success) 0%, #45a049 100%);
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(81,207,102,0.5);
  text-align: center;
  border: 3px solid rgba(255,255,255,0.2);
  position: relative;
  overflow: hidden;
}

.grand-total-card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
  transform: rotate(45deg);
  animation: shine 3s infinite;
}

@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.grand-total-label {
  font-size: 1.1em;
  color: rgba(255,255,255,0.95);
  margin-bottom: 10px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  position: relative;
  z-index: 1;
}

.grand-total-amount {
  font-size: 3.2em;
  color: white;
  font-weight: 900;
  line-height: 1;
  text-shadow: 0 4px 12px rgba(0,0,0,0.4);
  position: relative;
  z-index: 1;
}

.export-section {
  margin-top: 16px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

@media print {
  body {
    background: white;
    color: black;
  }
  
  .header, .btn, .export-section, .order-controls {
    display: none !important;
  }
  
  .card {
    box-shadow: none;
    border: 1px solid #ccc;
    page-break-inside: avoid;
  }
  
  .grand-total-card::before {
    display: none;
  }
}

/* Tablet */
@media (min-width: 600px) {
  body {
    padding: 20px;
  }
  
  .header {
    padding: 24px 20px;
  }
  
  .header h1 {
    font-size: 1.8em;
  }
  
  .header p {
    font-size: 1em;
  }
  
  .card {
    padding: 20px;
  }
  
  .card h2 {
    font-size: 1.5em;
  }
  
  .input-area {
    min-height: 320px;
    padding: 16px;
    font-size: 0.95em;
  }
  
  .button-group {
    flex-direction: row;
    gap: 12px;
  }
  
  .btn-row {
    display: flex;
  }
  
  .ingredient-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
  }
}

/* Desktop */
@media (min-width: 900px) {
  body {
    padding: 24px;
  }
  
  .header {
    padding: 28px 24px;
  }
  
  .header h1 {
    font-size: 2em;
  }
  
  .card {
    padding: 24px;
  }
  
  .input-area {
    min-height: 380px;
  }
  
  .ingredient-grid {
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }
  
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  
  .main-grid .card {
    margin-bottom: 0;
  }
}

html {
  scroll-behavior: smooth;
}

@media (max-width: 599px) {
  .btn {
    min-height: 54px;
    font-size: 1.05em;
  }
}

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-main);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>BISMILLAH BERKAH</h1>
    <p>Cita Rasa Indonesia Summarizer</p>
    <span class="ai-badge">‚ú® v2.3 - AUTO-MERGE FIXED</span>
  </div>

  <div class="main-grid">
    <div class="card">
      <h2>üìù Paste Orders</h2>
      <textarea 
        class="input-area" 
        id="orderInput"
        maxlength="5000"
        placeholder="AI bisa ngerti berbagai format!

‚úì Multi-item: prames a + ayam + bakwan 5
‚úì Typo: pramse, ayma, cumi2
‚úì Angka: dua, 2, x2, √ó2
‚úì Auto-merge item yang sama!
‚úì Export ke Telegram @CitaRasaIndo

Max 5000 characters"></textarea>
      
      <div class="toggle-container" onclick="document.getElementById('mergeToggle').click()">
        <input type="checkbox" id="mergeToggle" checked onclick="event.stopPropagation()">
        <label for="mergeToggle">üîñ Gabungkan item yang sama (RECOMMENDED)</label>
      </div>
      
      <div class="button-group">
        <button class="btn btn-primary" id="processBtn" onclick="calculateIngredients()">
          <span>üß†</span>
          <span>PROCESS WITH AI</span>
        </button>
        <div class="btn-row">
          <button class="btn btn-example" onclick="loadExample()">
            <span>üìã</span>
            <span>Example</span>
          </button>
          <button class="btn btn-secondary" onclick="clearAll()">
            <span>üóëÔ∏è</span>
            <span>Clear</span>
          </button>
        </div>
      </div>
      <div id="alertBox" class="alert"></div>
    </div>

    <div class="card">
      <h2>üîç Detected Orders</h2>
      <div id="ordersList" class="orders-list">
        <div class="empty-state">
          <div class="empty-state-icon">ü§ñ</div>
          <p>AI belum memproses pesanan</p>
          <p style="font-size: 0.85em; margin-top: 8px;">Now with AUTO-MERGE!</p>
        </div>
      </div>
    </div>
  </div>

  <div class="results-section" id="resultsSection">
    <div class="card">
      <h2>üç≥ Ingredients Needed</h2>
      <div class="summary-card">
        <div class="summary-row">
          <span>Total Orders:</span>
          <span id="totalOrders">0</span>
        </div>
        <div class="summary-row">
          <span>Unique Items:</span>
          <span id="uniqueItems">0</span>
        </div>
        <div class="summary-row">
          <span>Total Portions:</span>
          <span id="totalPortions">0</span>
        </div>
      </div>
      
      <div class="ingredient-grid" id="ingredientGrid"></div>
      
      <div class="grand-total-card" id="grandTotalCard" style="display:none;">
        <div class="grand-total-label">üí∞ TOTAL YANG HARUS DIBAYAR</div>
        <div class="grand-total-amount" id="grandTotalAmount">¬•0</div>
      </div>
      
      <div class="export-section">
        <button class="btn btn-secondary btn-small" onclick="exportAsText()">
            üìã Copy Text
        </button>
        <button class="btn btn-secondary btn-small" onclick="printResults()">
            üñ®Ô∏è Print
        </button>
      </div>
      
      <div id="chickenNotes" class="chicken-notes" style="display:none;">
        <strong>üçó Catatan Ayam:</strong> <span id="chickenDetails"></span>
      </div>
      
      <div id="notesSection" class="notes-section" style="display:none;">
        <h3>‚ö†Ô∏è PERLU KONFIRMASI</h3>
        <ul id="notesList"></ul>
      </div>
      
      <div id="undetectedSection" class="notes-section" style="display:none; border-color: var(--primary); background: rgba(255,107,107,0.1);">
        <h3 style="color: var(--primary);">üö® MENU TIDAK TERDETEKSI - PERLU INPUT MANUAL!</h3>
        <ul id="undetectedList"></ul>
      </div>
    </div>
  </div>
</div>

<script>
// CONSTANTS
const CONFIG = {
  BAKWAN_PACK_THRESHOLD: 3,
  BAKWAN_PRICE_PER_PACK: 5,
  MAX_INPUT_LENGTH: 5000,
  SIMILARITY_HIGH: 0.88,
  SIMILARITY_MEDIUM: 0.72,
  SIMILARITY_MIN: 0.65,
  DEBOUNCE_MS: 300,
  AUTO_SAVE_KEY: 'citarasa_orders',
  TIMESTAMP_KEY: 'citarasa_timestamp'
};

// CHICKEN TRACKER CLASS
class ChickenTracker {
  constructor() {
    this.reset();
  }
  
  reset() {
    this.paha = 0;
    this.dada = 0;
    this.random = 0;
  }
  
  get total() {
    return this.paha + this.dada + this.random;
  }
  
  get withPreference() {
    return this.paha + this.dada;
  }
  
  add(type, qty) {
    if (['paha', 'dada', 'random'].includes(type)) {
      this[type] += qty;
    }
  }
  
  subtract(type, qty) {
    if (['paha', 'dada', 'random'].includes(type)) {
      this[type] = Math.max(0, this[type] - qty);
    }
  }
  
  getSummary() {
    const parts = [];
    if (this.paha > 0) parts.push(`Paha: ${this.paha} potong`);
    if (this.dada > 0) parts.push(`Dada: ${this.dada} potong`);
    if (this.random > 0) parts.push(`Random: ${this.random} potong`);
    return parts.join(' | ');
  }
}

// ERROR LOGGING
class ErrorLogger {
  constructor() {
    this.errors = [];
    this.maxErrors = 50;
  }
  
  log(context, error, data = {}) {
    const errorEntry = {
      timestamp: new Date().toISOString(),
      context,
      message: error.message || String(error),
      stack: error.stack,
      data
    };
    
    this.errors.push(errorEntry);
    if (this.errors.length > this.maxErrors) {
      this.errors.shift();
    }
    
    console.error(`[${context}]`, error, data);
    
    try {
      localStorage.setItem('citarasa_errors', JSON.stringify(this.errors.slice(-10)));
    } catch (e) {
      // Ignore localStorage errors
    }
  }
  
  getRecentErrors(count = 5) {
    return this.errors.slice(-count);
  }
  
  clear() {
    this.errors = [];
    localStorage.removeItem('citarasa_errors');
  }
}

// GLOBAL STATE
const state = {
  orders: [],
  specialNotes: [],
  undetectedLines: [],
  chickenTracker: new ChickenTracker(),
  errorLogger: new ErrorLogger(),
  isProcessing: false
};

// INPUT SANITIZATION
function sanitizeInput(text) {
  if (!text || typeof text !== 'string') return '';
  
  return text
    .replace(/[<>\"\'`]/g, '')
    .replace(/javascript:/gi, '')
    .replace(/on\w+\s*=/gi, '')
    .substring(0, CONFIG.MAX_INPUT_LENGTH)
    .trim();
}

const typoMap = {
  'pramse': 'prames', 'prams': 'prames', 'prmase': 'prames',
  'ayma': 'ayam', 'aym': 'ayam',
  'telor': 'telur', 'telorr': 'telur', 'tlur': 'telur',
  'cumi2': 'cumi', 'cumii': 'cumi',
  'teri2': 'teri',
  'bakwn': 'bakwan', 'bakawn': 'bakwan', 'bakwan2': 'bakwan',
  'krems': 'kremes', 'kremess': 'kremes',
  'sambel': 'sambal', 'samba': 'sambal',
  'kentng': 'kentang',
  'balad': 'balado',
  'nasii': 'nasi', 'nasi2': 'nasi',
  'pahaa': 'paha'
};

const wordToNumber = {
  'satu': 1, 'sat': 1, 'se': 1,
  'dua': 2, 'du': 2,
  'tiga': 3, 'tig': 3,
  'empat': 4, 'empt': 4,
  'lima': 5, 'lim': 5,
  'enam': 6, 'tujuh': 7, 'delapan': 8, 'sembilan': 9,
  'sepuluh': 10, 'puluh': 10
};

const noiseWords = ['untuk', 'dong', 'ya', 'aja', 'deh', 'kak', 'bang', 'mbak', 'mas', 'pak', 'bu', 'tolong', 'minta', 'mau', 'order', 'pesan'];
const exclusionKeywords = ['tanpa', 'gak', 'ga', 'tidak', 'no', 'without', 'minus', 'kecuali'];

const menuAI = {
  'PARARI': { patterns: ['parari', 'para ri', 'paket teri', 'ricebowl teri', 'rice bowl teri', 'nasi bowl teri', 'bowl teri', 'rb teri'], price: 25, ingredients: { chicken: 0, egg_ceplok: 1, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 1, sambal_cumi: 0, nasi: 1, kremes: 0, timun: 2, sambal: 0 } },
  'PARACU': { patterns: ['paracu', 'para cu', 'paket cumi', 'ricebowl cumi', 'rice bowl cumi', 'nasi bowl cumi', 'bowl cumi', 'nasbol cumi', 'rb cumi'], price: 25, ingredients: { chicken: 0, egg_ceplok: 1, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 0, sambal_cumi: 1, nasi: 1, kremes: 0, timun: 2, sambal: 0 } },
  'PARAKUS': { patterns: ['parakus', 'para kus', 'rakus', 'paket rakus', 'ricebowl rakus', 'rice bowl rakus', 'bowl rakus', 'rb rakus'], price: 30, ingredients: { chicken: 0, egg_ceplok: 1, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 1, sambal_cumi: 1, nasi: 1, kremes: 0, timun: 2, sambal: 0 } },
  'PARABO': { patterns: ['parabo', 'para bo', 'karbo', 'paket karbo', 'ricebowl karbo', 'bowl karbo', 'rb karbo'], price: 23, ingredients: { chicken: 0, egg_ceplok: 1, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 0, timun: 2, sambal: 0, potato_balado_small: 1 } },
  'PAYALUR': { patterns: ['payalur', 'paya lur', 'paket ayam telur'], price: 35, ingredients: { chicken: 1, egg_ceplok: 0, egg_balado: 1, egg_dadar: 0, potato_small: 1, potato_big: 0, bakwan: 1, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 0, timun: 0, sambal: 1 } },
  'PAYALIT': { patterns: ['payalit', 'paya lit'], price: 30, ingredients: { chicken: 1, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 1, potato_big: 0, bakwan: 1, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 0, timun: 0, sambal: 1 } },
  'PAYAMAT': { patterns: ['payamat', 'paya mat', 'paket ayam'], price: 25, ingredients: { chicken: 1, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 1, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 0, timun: 0, sambal: 1 } },
  'PALUTANG': { patterns: ['palutang', 'palu tang', 'paket telur kentang'], price: 25, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 1, egg_dadar: 0, potato_small: 1, potato_big: 0, bakwan: 2, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 0, timun: 0, sambal: 0 } },
  'PALUR': { patterns: ['palur', 'pa lur', 'paket telur'], price: 20, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 1, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 2, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 0, timun: 0, sambal: 0 } },
  'PRAMES A': { patterns: ['prames a', 'pramesa', 'prames 1', 'prames ayam'], price: 25, ingredients: { chicken: 1, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 2, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 1, timun: 2, sambal: 1 } },
  'PRAMES B': { patterns: ['prames b', 'pramesb', 'prames 2'], price: 33, ingredients: { chicken: 1, egg_ceplok: 0, egg_balado: 1, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 2, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 1, timun: 2, sambal: 1 } },
  'PRAMES C': { patterns: ['prames c', 'pramesc', 'prames 3'], price: 30, ingredients: { chicken: 1, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 1, potato_big: 0, bakwan: 0, tofu: 2, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 1, timun: 2, sambal: 1 } },
  'PRAMES KARBO': { patterns: ['prames karbo', 'prames kentang', 'pramkarbo'], price: 20, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 1, potato_big: 0, bakwan: 2, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 1, timun: 0, sambal: 1 } },
  'PRAMES VEGGIE': { patterns: ['prames veggie', 'prames vegetarian', 'prames sayur', 'pram veggie'], price: 15, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 2, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 1, timun: 2, sambal: 1 } },
  'AYAM GORENG': { patterns: ['ayam goreng', 'ayam', 'chicken', 'ayam aja', 'add ayam', 'plus ayam'], price: 15, ingredients: { chicken: 1, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 0, kremes: 0, timun: 0, sambal: 0 } },
  'TELUR DADAR': { patterns: ['telur dadar', 'telor dadar', 'dadar', 'omelet', 'omelette'], price: 8, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 0, egg_dadar: 1, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 0, kremes: 0, timun: 0, sambal: 0 } },
  'KENTANG BALADO': { patterns: ['kentang balado', 'kentang', 'potato balado', 'balado kentang'], price: 10, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 1, bakwan: 0, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 0, kremes: 0, timun: 0, sambal: 0 } },
  'TELUR BALADO': { patterns: ['telur balado', 'telor balado', 'balado telur', 'egg balado'], price: 10, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 1, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 0, kremes: 0, timun: 0, sambal: 0 } },
  'TELUR CEPLOK': { patterns: ['telur ceplok', 'telor ceplok', 'ceplok', 'fried egg', 'telur goreng'], price: 7, ingredients: { chicken: 0, egg_ceplok: 1, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 0, kremes: 0, timun: 0, sambal: 0 } },
  'BAKWAN 3PCS': { patterns: ['bakwan', 'bala bala', 'gorengan', 'bakwan sayur'], price: 5, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 3, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 0, kremes: 0, timun: 0, sambal: 0 } },
  'EXTRA KREMES': { patterns: ['kremes', 'extra kremes', 'kremesan', 'remah', 'add kremes'], price: 5, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 0, kremes: 1, timun: 0, sambal: 0 } },
  'EXTRA SAMBEL': { patterns: ['sambel', 'sambal', 'extra sambel', 'extra sambal', 'add sambel', 'plus sambal'], price: 3, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 0, kremes: 0, timun: 0, sambal: 1 } },
  'NASI PUTIH': { patterns: ['nasi putih', 'nasi', 'rice', 'nasi aja', 'tambah nasi', 'add nasi', 'plus nasi'], price: 5, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 1, kremes: 0, timun: 0, sambal: 0 } },
  'SANCODUT': { patterns: ['sancodut', 'sangcodut', 'pisang cokelat', 'pisang coklat gendut', 'piscobar'], price: 15, ingredients: { chicken: 0, egg_ceplok: 0, egg_balado: 0, egg_dadar: 0, potato_small: 0, potato_big: 0, bakwan: 0, tofu: 0, sambal_teri: 0, sambal_cumi: 0, nasi: 0, kremes: 0, timun: 0, sambal: 0, sancodut: 1 } }
};

const ingredientIcons = {
  chicken: { icon: 'üçó', name: 'Ayam Goreng', unit: 'potong' },
  egg_ceplok: { icon: 'üç≥', name: 'Telur Ceplok', unit: 'butir' },
  egg_balado: { icon: 'ü•ö', name: 'Telur Balado', unit: 'butir' },
  egg_dadar: { icon: 'üç≥', name: 'Telur Dadar', unit: 'butir' },
  potato_small: { icon: 'ü•î', name: 'Kentang Balado (Small)', unit: 'porsi' },
  potato_big: { icon: 'ü•î', name: 'Kentang Balado (Big)', unit: 'porsi' },
  potato_balado_small: { icon: 'ü•î', name: 'Kentang Balado (S)', unit: 'porsi' },
  bakwan: { icon: 'ü•ô', name: 'Bakwan', unit: 'pcs' },
  tofu: { icon: 'üßà', name: 'Tahu', unit: 'potong' },
  sambal_teri: { icon: 'üå∂Ô∏è', name: 'Sambal Teri', unit: 'porsi' },
  sambal_cumi: { icon: 'ü¶ë', name: 'Sambal Cumi', unit: 'porsi' },
  sambal: { icon: 'üå∂Ô∏è', name: 'Sambal (Pack)', unit: 'pack' },
  nasi: { icon: 'üçö', name: 'Nasi Putih', unit: 'centong' },
  kremes: { icon: '‚ú®', name: 'Kremes', unit: 'pc' },
  timun: { icon: 'ü•í', name: 'Timun', unit: 'potong' },
  sancodut: { icon: 'üçå', name: 'Sancodut', unit: 'porsi' }
};

// DATA PERSISTENCE
function saveState() {
  try {
    localStorage.setItem(CONFIG.AUTO_SAVE_KEY, JSON.stringify(state.orders));
    localStorage.setItem(CONFIG.TIMESTAMP_KEY, Date.now());
  } catch (error) {
    state.errorLogger.log('saveState', error);
  }
}

function loadState() {
  try {
    const saved = localStorage.getItem(CONFIG.AUTO_SAVE_KEY);
    const timestamp = localStorage.getItem(CONFIG.TIMESTAMP_KEY);
    
    if (saved && timestamp) {
      const age = Date.now() - parseInt(timestamp);
      if (age < 24 * 60 * 60 * 1000) {
        state.orders = JSON.parse(saved);
        if (state.orders.length > 0) {
          calculateIngredientsFromParsedOrders();
          showAlert(`‚úÖ Loaded ${state.orders.length} saved orders`, 'info');
        }
      } else {
        localStorage.removeItem(CONFIG.AUTO_SAVE_KEY);
        localStorage.removeItem(CONFIG.TIMESTAMP_KEY);
      }
    }
  } catch (error) {
    state.errorLogger.log('loadState', error);
  }
}

function fixTypos(text) {
  let fixed = text.toLowerCase();
  for (const [typo, correct] of Object.entries(typoMap)) {
    const regex = new RegExp('\\b' + typo + '\\b', 'gi');
    fixed = fixed.replace(regex, correct);
  }
  return fixed;
}

function convertWordNumbers(text) {
  let converted = text;
  for (const [word, num] of Object.entries(wordToNumber)) {
    const regex = new RegExp('\\b' + word + '\\b', 'gi');
    converted = converted.replace(regex, num.toString());
  }
  return converted;
}

function removeNoise(text) {
  let cleaned = text;
  for (const noise of noiseWords) {
    const regex = new RegExp('\\b' + noise + '\\b', 'gi');
    cleaned = cleaned.replace(regex, '');
  }
  return cleaned.trim();
}

function hasExclusion(text) {
  return exclusionKeywords.some(keyword => text.toLowerCase().includes(keyword));
}

function calculateSimilarity(str1, str2) {
  str1 = str1.toLowerCase().replace(/[^a-z0-9]/g, '');
  str2 = str2.toLowerCase().replace(/[^a-z0-9]/g, '');
  
  if (str1 === str2) return 1.0;
  if (str1.includes(str2) || str2.includes(str1)) return 0.85;
  
  const len1 = str1.length;
  const len2 = str2.length;
  const matrix = [];
  
  for (let i = 0; i <= len1; i++) matrix[i] = [i];
  for (let j = 0; j <= len2; j++) matrix[0][j] = j;
  
  for (let i = 1; i <= len1; i++) {
    for (let j = 1; j <= len2; j++) {
      if (str1.charAt(i - 1) === str2.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
      }
    }
  }
  
  const distance = matrix[len1][len2];
  const maxLen = Math.max(len1, len2);
  return 1 - (distance / maxLen);
}

function extractQuantity(text) {
  text = fixTypos(text);
  text = convertWordNumbers(text);
  
  if (text.toLowerCase().includes('bakwan')) {
    const packMatch = text.match(/bakwan\s*(\d+)\s*pack/i);
    const pcsMatch = text.match(/bakwan\s*(\d+)\s*(?:pcs|pc|potong|buah)/i);
    
    if (packMatch) {
      const num = parseInt(packMatch[1]);
      return { qty: num, isBakwanPack: true, bakwanPcs: num * 3 };
    } else if (pcsMatch) {
      const num = parseInt(pcsMatch[1]);
      const packs = Math.ceil(num / 3);
      return { qty: packs, isBakwanPack: true, bakwanPcs: num };
    } else {
      const bakwanMatch = text.match(/bakwan\s*(\d+)/i);
      if (bakwanMatch) {
        const num = parseInt(bakwanMatch[1]);
        if (num <= CONFIG.BAKWAN_PACK_THRESHOLD) {
          const packs = Math.ceil(num / 3);
          return { qty: packs, isBakwanPack: true, bakwanPcs: num };
        } else {
          return { qty: num, isBakwanPack: true, bakwanPcs: num * 3 };
        }
      }
    }
  }
  
  const patterns = [
    /[xX√ó*]\s*(\d+)/, /(\d+)\s*[xX√ó*]/, /(\d+)\s*porsi/i, /(\d+)\s*pcs/i,
    /(\d+)\s*pc/i, /(\d+)\s*buah/i, /(\d+)\s*bh/i, /(\d+)\s*potong/i,
    /(\d+)\s*ptg/i, /(\d+)\s*pack/i
  ];
  
  for (const pattern of patterns) {
    const match = text.match(pattern);
    if (match) return { qty: parseInt(match[1]), isBakwanPack: false, bakwanPcs: 0 };
  }
  
  if (text.includes('sama') || text.includes('dan') || text.includes('+')) {
    return { qty: 2, isBakwanPack: false, bakwanPcs: 0 };
  }
  
  return { qty: 1, isBakwanPack: false, bakwanPcs: 0 };
}

function matchMenuItem(line) {
  let cleanLine = fixTypos(line);
  cleanLine = convertWordNumbers(cleanLine);
  cleanLine = removeNoise(cleanLine);
  cleanLine = cleanLine.toLowerCase()
    .replace(/[¬•üí¥]\s*\d+/g, '')
    .replace(/rmb\s*\d+/gi, '')
    .replace(/‚ñ∂Ô∏è|üëå|üçó|üç≥|ü•î|üç±|ü•¨|üí™|‚ñ™Ô∏è/g, '')
    .replace(/\([^)]*\)/g, '')
    .trim();
  
  if (!menuAI || Object.keys(menuAI).length === 0) {
    throw new Error('menuAI database is empty or undefined!');
  }
  
  let bestMatch = null;
  let bestScore = 0;
  let matchedPattern = '';
  
  for (const [menuName, menuData] of Object.entries(menuAI)) {
    if (!menuData || !menuData.patterns || !Array.isArray(menuData.patterns)) {
      state.errorLogger.log('matchMenuItem', new Error(`Invalid menu data for ${menuName}`));
      continue;
    }
    
    for (const pattern of menuData.patterns) {
      const similarity = calculateSimilarity(cleanLine, pattern);
      
      if (cleanLine.includes(pattern)) {
        const score = Math.max(similarity, 0.92);
        if (score > bestScore) {
          bestScore = score;
          bestMatch = menuName;
          matchedPattern = pattern;
        }
      } else if (similarity > bestScore && similarity > CONFIG.SIMILARITY_MIN) {
        bestScore = similarity;
        bestMatch = menuName;
        matchedPattern = pattern;
      }
    }
  }
  
  let confidence = 'low';
  if (bestScore >= CONFIG.SIMILARITY_HIGH) confidence = 'high';
  else if (bestScore >= CONFIG.SIMILARITY_MEDIUM) confidence = 'medium';
  
  return bestMatch ? { item: bestMatch, confidence, score: bestScore, pattern: matchedPattern } : null;
}

function processOrderLine(line, originalLine, orders) {
  if (hasExclusion(line)) {
    state.specialNotes.push(`"${originalLine}" - Mengandung exclusion (tanpa/no), mohon konfirmasi manual!`);
    return;
  }
  
  const qtyResult = extractQuantity(line);
  let qty = qtyResult.qty;
  const match = matchMenuItem(line);
  
  if (match && menuAI[match.item]) {
    let chickenType = 'random';
    
    if (menuAI[match.item].ingredients.chicken > 0) {
      const lowerLine = originalLine.toLowerCase();
      if (lowerLine.includes('paha')) {
        chickenType = 'paha';
      } else if (lowerLine.includes('dada')) {
        chickenType = 'dada';
      }
      
      state.chickenTracker.add(chickenType, qty * menuAI[match.item].ingredients.chicken);
    }
    
    let finalPrice = menuAI[match.item].price * qty;
    if (match.item === 'BAKWAN 3PCS' && qtyResult.isBakwanPack) {
      finalPrice = CONFIG.BAKWAN_PRICE_PER_PACK * qty;
      state.specialNotes.push(`‚úì Bakwan ${qty} pack detected (${qtyResult.bakwanPcs} pcs total) = ¬•${finalPrice}`);
    }
    
    if (originalLine.toLowerCase().includes('extra sambal cumi') || 
        originalLine.toLowerCase().includes('extra sambal teri')) {
      state.specialNotes.push(`"${originalLine}" - Extra sambal khusus cumi/teri belum tersedia!`);
    }
    
    orders.push({
      name: match.item,
      qty,
      price: menuAI[match.item].price,
      totalPrice: finalPrice,
      isBakwanPack: qtyResult.isBakwanPack,
      bakwanPcs: qtyResult.bakwanPcs || 0,
      ingredients: menuAI[match.item].ingredients,
      original: originalLine,
      confidence: match.confidence,
      score: match.score,
      chickenType: chickenType !== 'random' ? chickenType : null
    });
  } else {
    if (line.length > 3) {
      state.undetectedLines.push(originalLine);
    }
  }
}

function parseOrdersAI(text) {
  const lines = text.split('\n');
  const orders = [];
  state.specialNotes = [];
  state.undetectedLines = [];
  state.chickenTracker.reset();
  
  for (let line of lines) {
    const originalLine = line;
    line = line.trim();
    if (!line || line.length < 2) continue;
    if (/^[-=_]+$/.test(line)) continue;
    
    const multiItemDelimiters = /\s*[\+,]\s*(?=(?:[^"]*"[^"]*")*[^"]*$)/g;
    const potentialItems = line.split(multiItemDelimiters);
    
    if (potentialItems.length > 1) {
      for (let subLine of potentialItems) {
        subLine = subLine.trim();
        if (subLine.length < 2) continue;
        processOrderLine(subLine, subLine, orders);
      }
    } else {
      processOrderLine(line, originalLine, orders);
    }
  }
  
  return orders;
}

// üî• FIX: AUTO-MERGE FUNCTION
function mergeOrders(orders) {
  const merged = new Map();
  
  for (const order of orders) {
    // Create unique key: menu name + chicken preference
    const chickenKey = order.chickenType || 'none';
    const key = `${order.name}__${chickenKey}`;
    
    if (merged.has(key)) {
      const existing = merged.get(key);
      existing.qty += order.qty;
      existing.totalPrice += order.totalPrice;
      existing.originals.push(order.original);
      existing.mergeCount++;
      
      if (order.isBakwanPack) {
        existing.bakwanPcs += order.bakwanPcs;
      }
      
      // Keep highest confidence
      if (order.score > existing.score) {
        existing.confidence = order.confidence;
        existing.score = order.score;
      }
    } else {
      merged.set(key, {
        ...order,
        originals: [order.original],
        mergeCount: 1
      });
    }
  }
  
  // Convert back to array with combined original text
  return Array.from(merged.values()).map(order => {
    if (order.mergeCount > 1) {
      return {
        ...order,
        original: `üîñ ${order.mergeCount}x dari: "${order.originals.join('", "')}"`,
        isMerged: true
      };
    } else {
      return {
        ...order,
        original: order.originals[0],
        isMerged: false
      };
    }
  });
}

function calculateIngredients() {
  if (state.isProcessing) {
    showAlert('‚è≥ Masih proses sebelumnya, tunggu sebentar...', 'warning');
    return;
  }
  
  let input = sanitizeInput(document.getElementById('orderInput').value);
  
  if (input.length > CONFIG.MAX_INPUT_LENGTH) {
    showAlert(`‚ö†Ô∏è Input terlalu panjang! Max ${CONFIG.MAX_INPUT_LENGTH} characters. Current: ${input.length}`, 'warning');
    return;
  }
  
  if (!input) {
    showAlert('Paste pesanan dulu ya! üòä', 'warning');
    return;
  }
  
  state.isProcessing = true;
  const processBtn = document.getElementById('processBtn');
  processBtn.disabled = true;
  processBtn.innerHTML = '<span>‚è≥</span><span>PROCESSING...</span>';
  
  document.getElementById('ordersList').innerHTML = '<div class="processing"><div class="processing-icon">ü§ñ</div><p>AI ENHANCED processing...</p></div>';
  
  setTimeout(() => {
    try {
      let rawOrders = parseOrdersAI(input);
      
      // Apply merge if toggle is checked
      if (document.getElementById('mergeToggle').checked) {
        state.orders = mergeOrders(rawOrders);
      } else {
        state.orders = rawOrders;
      }
      
      if (state.orders.length === 0 && state.undetectedLines.length === 0) {
        showAlert('Tidak ada pesanan valid terdeteksi ü§î Coba format lain!', 'warning');
        document.getElementById('ordersList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Tidak ada pesanan</p></div>';
        return;
      }
      
      saveState();
      calculateIngredientsFromParsedOrders();
      
      let grandTotal = state.orders.reduce((sum, o) => sum + o.totalPrice, 0);
      const mergedCount = state.orders.filter(o => o.isMerged).length;
      let alertMsg = `‚úÖ SUKSES! ${state.orders.length} pesanan`;
      
      if (mergedCount > 0) {
        alertMsg += ` (${mergedCount} merged)`;
      }
      
      alertMsg += ` | TOTAL: ¬•${grandTotal}`;
      let alertType = 'success';
      
      if (state.undetectedLines.length > 0) {
        alertMsg = `‚ö†Ô∏è ${state.orders.length} pesanan terdeteksi | ${state.undetectedLines.length} MENU TIDAK TERDETEKSI! | Total: ¬•${grandTotal}`;
        alertType = 'warning';
      }
      
      showAlert(alertMsg, alertType);
      document.getElementById('resultsSection').classList.add('active');
      setTimeout(() => {
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    } catch (error) {
      state.errorLogger.log('calculateIngredients', error, { input });
      showAlert('‚ùå Error: ' + error.message, 'error');
      document.getElementById('ordersList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error processing</p></div>';
    } finally {
      state.isProcessing = false;
      processBtn.disabled = false;
      processBtn.innerHTML = '<span>üß†</span><span>PROCESS WITH AI</span>';
    }
  }, CONFIG.DEBOUNCE_MS);
}

function calculateIngredientsFromParsedOrders() {
  displayOrders();
  
  const totals = {};
  let totalPortions = 0;
  let grandTotal = 0;
  
  for (const order of state.orders) {
    const orderQty = order.qty;
    totalPortions += orderQty;
    grandTotal += order.totalPrice;
    
    for (const [ingredient, amount] of Object.entries(order.ingredients)) {
      if (!totals[ingredient]) totals[ingredient] = 0;
      
      if (ingredient === 'bakwan' && order.isBakwanPack && order.name === 'BAKWAN 3PCS') {
        totals[ingredient] += order.bakwanPcs;
      } else {
        totals[ingredient] += amount * orderQty;
      }
    }
  }
  
  displayResults(totals, state.orders.length, totalPortions, grandTotal);
}

function deleteOrder(index) {
  if (!confirm('Hapus pesanan ini?')) return;
  
  try {
    const order = state.orders[index];
    
    if (order.ingredients.chicken > 0) {
      const chickenQty = order.qty * order.ingredients.chicken;
      const type = order.chickenType || 'random';
      state.chickenTracker.subtract(type, chickenQty);
    }
    
    state.orders.splice(index, 1);
    saveState();
    calculateIngredientsFromParsedOrders();
    
    if (state.orders.length === 0) {
      document.getElementById('resultsSection').classList.remove('active');
      showAlert('Semua pesanan dihapus!', 'info');
    }
  } catch (error) {
    state.errorLogger.log('deleteOrder', error, { index });
    showAlert('‚ùå Error deleting order', 'error');
  }
}

function adjustQty(index, delta) {
  try {
    const order = state.orders[index];
    if (order.qty + delta < 1) return;
    
    if (order.ingredients.chicken > 0) {
      const chickenDelta = delta * order.ingredients.chicken;
      const type = order.chickenType || 'random';
      if (delta > 0) {
        state.chickenTracker.add(type, chickenDelta);
      } else {
        state.chickenTracker.subtract(type, Math.abs(chickenDelta));
      }
    }
    
    order.qty += delta;
    
    if (order.isBakwanPack) {
      order.totalPrice = CONFIG.BAKWAN_PRICE_PER_PACK * order.qty;
      order.bakwanPcs = order.qty * 3;
    } else {
      order.totalPrice = order.price * order.qty;
    }
    
    saveState();
    calculateIngredientsFromParsedOrders();
  } catch (error) {
    state.errorLogger.log('adjustQty', error, { index, delta });
    showAlert('‚ùå Error adjusting quantity', 'error');
  }
}

function displayOrders() {
  const container = document.getElementById('ordersList');
  
  if (state.orders.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ü§ñ</div><p>Belum ada pesanan</p></div>';
    return;
  }
  
  const orderItems = state.orders.map((order, index) => {
    const confidenceClass = `confidence-${order.confidence}`;
    const confidenceLabel = order.confidence === 'high' ? '‚úì' : 
                           order.confidence === 'medium' ? '~' : '?';
    
    let bakwanNote = '';
    if (order.isBakwanPack && order.name === 'BAKWAN 3PCS') {
      bakwanNote = ` <span style="color: var(--warning); font-weight: 700;">(${order.qty} PACK = ${order.bakwanPcs} PCS!)</span>`;
    }
    
    const mergedClass = order.isMerged ? 'merged' : '';
    const mergedBadge = order.isMerged ? '<span class="merged-badge">MERGED</span>' : '';
    
    return `
      <div class="order-item ${mergedClass}">
        <div class="order-controls">
          <div class="qty-spinner">
            <button class="qty-btn" onclick="adjustQty(${index}, -1)">‚àí</button>
            <span class="qty-display">${order.qty}</span>
            <button class="qty-btn" onclick="adjustQty(${index}, 1)">+</button>
          </div>
          <button class="btn btn-delete" onclick="deleteOrder(${index})" title="Hapus">√ó</button>
        </div>
        <div class="order-header">
          <div class="order-name">
            ${order.name}${bakwanNote}${mergedBadge}
            <div class="${confidenceClass} confidence-badge">${confidenceLabel} ${order.confidence === 'high' ? 'Yakin' : order.confidence === 'medium' ? 'Cukup' : 'Ragu'}</div>
          </div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; gap: 10px;">
          <div class="order-original">${order.original}</div>
          <div class="order-price">¬•${order.totalPrice}</div>
        </div>
      </div>
    `;
  }).join('');
  
  const grandTotal = state.orders.reduce((sum, order) => sum + order.totalPrice, 0);
  
  const totalSummary = `
    <div class="total-price-box">
      <div class="total-price-label">üí∞ TOTAL HARGA</div>
      <div class="total-price-amount">¬•${grandTotal}</div>
    </div>
  `;
  
  container.innerHTML = orderItems + totalSummary;
}

function displayResults(totals, orderCount, totalPortions, grandTotal) {
  document.getElementById('totalOrders').textContent = orderCount;
  document.getElementById('uniqueItems').textContent = Object.keys(totals).filter(k => totals[k] > 0).length;
  document.getElementById('totalPortions').textContent = totalPortions;
  
  const grid = document.getElementById('ingredientGrid');
  const ingredientCards = [];
  
  for (const [key, qty] of Object.entries(totals)) {
    if (qty > 0 && ingredientIcons[key]) {
      const info = ingredientIcons[key];
      
      let displayQty = qty;
      let displayUnit = info.unit;
      
      if (key === 'bakwan') {
        const packs = Math.ceil(qty / 3);
        displayUnit = `pcs (${packs} pack)`;
      }
      
      const isHighlighted = key === 'chicken' || key === 'bakwan' || key === 'nasi';
      
      ingredientCards.push(`
        <div class="ingredient-card ${isHighlighted ? 'highlight' : ''}">
          <div class="ingredient-icon">${info.icon}</div>
          <div class="ingredient-name">${info.name}</div>
          <div class="ingredient-qty">${displayQty}</div>
          <div class="ingredient-unit">${displayUnit}</div>
        </div>
      `);
    }
  }
  
  grid.innerHTML = ingredientCards.join('');
  
  if (grandTotal > 0) {
    document.getElementById('grandTotalCard').style.display = 'block';
    document.getElementById('grandTotalAmount').textContent = `¬•${grandTotal}`;
  }
  
  if (state.chickenTracker.total > 0) {
    document.getElementById('chickenNotes').style.display = 'block';
    document.getElementById('chickenDetails').textContent = state.chickenTracker.getSummary();
  } else {
    document.getElementById('chickenNotes').style.display = 'none';
  }
  
  if (state.specialNotes.length > 0) {
    document.getElementById('notesSection').style.display = 'block';
    document.getElementById('notesList').innerHTML = state.specialNotes.map(note => `<li>${note}</li>`).join('');
  } else {
    document.getElementById('notesSection').style.display = 'none';
  }
  
  if (state.undetectedLines.length > 0) {
    document.getElementById('undetectedSection').style.display = 'block';
    document.getElementById('undetectedList').innerHTML = state.undetectedLines.map(line => 
      `<li style="color: var(--primary); font-weight: 600;">"${line}"</li>`
    ).join('');
  } else {
    document.getElementById('undetectedSection').style.display = 'none';
  }
}

function exportAsText() {
  try {
    let output = "üç± CITA RASA INDO - ORDER SUMMARY\n";
    output += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
    
    output += "üìã PESANAN:\n\n";
    
    state.orders.forEach((order, i) => {
      let bakwanNote = '';
      if (order.isBakwanPack && order.name === 'BAKWAN 3PCS') {
        bakwanNote = ` (${order.qty} PACK = ${order.bakwanPcs} PCS)`;
      }
      const mergeTag = order.isMerged ? ' üîñ' : '';
      output += `${i+1}. ${order.name}${bakwanNote}${mergeTag} x${order.qty} = ¬•${order.totalPrice}\n`;
    });
    
    const grandTotal = state.orders.reduce((sum, o) => sum + o.totalPrice, 0);
    output += `\nüí∞ TOTAL: ¬•${grandTotal}\n`;
    
    output += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    output += "üç≥ BAHAN YANG DIBUTUHKAN:\n\n";
    
    const totals = {};
    for (const order of state.orders) {
      for (const [ingredient, amount] of Object.entries(order.ingredients)) {
        if (!totals[ingredient]) totals[ingredient] = 0;
        if (ingredient === 'bakwan' && order.isBakwanPack && order.name === 'BAKWAN 3PCS') {
          totals[ingredient] += order.bakwanPcs;
        } else {
          totals[ingredient] += amount * order.qty;
        }
      }
    }
    
    // Kelompokkan bahan berdasarkan kategori
    const groups = {
      '**PROTEIN**': ['chicken', 'egg_ceplok', 'egg_balado', 'egg_dadar', 'tofu'],
      '\n**SAYURAN**': ['potato_small', 'potato_big', 'potato_balado_small', 'bakwan', 'timun'],
      '\n**SAMBAL & BUMBU**': ['sambal_teri', 'sambal_cumi', 'sambal', 'kremes'],
      '\n**KARBOHIDRAT**': ['nasi'],
      '\n**DESSERT**': ['sancodut']
    };
    
    for (const [groupName, keys] of Object.entries(groups)) {
      const groupItems = keys.filter(key => totals[key] > 0);
      if (groupItems.length > 0) {
        output += `${groupName}\n`;
        groupItems.forEach(key => {
          const qty = totals[key];
          const info = ingredientIcons[key];
          if (key === 'bakwan') {
            const packs = Math.ceil(qty / 3);
            output += `  ${info.icon} ${info.name}: ${qty} pcs (${packs} pack)\n`;
          } else {
            output += `  ${info.icon} ${info.name}: ${qty} ${info.unit}\n`;
          }
        });
      }
    }
    
    if (state.chickenTracker.total > 0) {
      output += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      output += `üçó CATATAN AYAM:\n`;
      output += `Total: ${state.chickenTracker.total} potong\n`;
      if (state.chickenTracker.paha > 0) output += `‚Ä¢ Paha: ${state.chickenTracker.paha} potong\n`;
      if (state.chickenTracker.dada > 0) output += `‚Ä¢ Dada: ${state.chickenTracker.dada} potong\n`;
      if (state.chickenTracker.random > 0) output += `‚Ä¢ Random: ${state.chickenTracker.random} potong\n`;
    }
    
    if (state.specialNotes.length > 0) {
      output += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      output += `‚ö†Ô∏è KONFIRMASI DIPERLUKAN:\n`;
      state.specialNotes.forEach(note => {
        output += `‚Ä¢ ${note}\n`;
      });
    }
    
    if (state.undetectedLines.length > 0) {
      output += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      output += `üö® MENU TIDAK TERDETEKSI:\n`;
      state.undetectedLines.forEach(line => {
        output += `‚Ä¢ "${line}"\n`;
      });
    }
    
    output += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    output += `**‚ú® DOUBLE CHECK PLEASE!**`;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(output).then(() => {
        showAlert('‚úÖ Copied to clipboard!', 'success');
      }).catch(err => {
        state.errorLogger.log('exportAsText', err);
        const textarea = document.createElement('textarea');
        textarea.value = output;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showAlert('‚úÖ Copied using fallback!', 'success');
      });
    } else {
      const textarea = document.createElement('textarea');
      textarea.value = output;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      showAlert('‚úÖ Copied!', 'success');
    }
  } catch (error) {
    state.errorLogger.log('exportAsText', error);
    showAlert('‚ùå Export failed: ' + error.message, 'error');
  }
}

function printResults() {
  window.print();
}

function showAlert(message, type) {
  const alertBox = document.getElementById('alertBox');
  alertBox.textContent = message;
  alertBox.className = `alert alert-${type} show`;
  
  setTimeout(() => alertBox.classList.remove('show'), 5000);
}

function clearAll() {
  if (state.orders.length > 0 && !confirm('Hapus semua data?')) {
    return;
  }
  
  document.getElementById('orderInput').value = '';
  state.orders = [];
  state.specialNotes = [];
  state.undetectedLines = [];
  state.chickenTracker.reset();
  
  localStorage.removeItem(CONFIG.AUTO_SAVE_KEY);
  localStorage.removeItem(CONFIG.TIMESTAMP_KEY);
  
  displayOrders();
  document.getElementById('resultsSection').classList.remove('active');
  document.getElementById('alertBox').classList.remove('show');
  document.getElementById('ingredientGrid').innerHTML = '';
  document.getElementById('grandTotalCard').style.display = 'none';
  document.getElementById('chickenNotes').style.display = 'none';
  document.getElementById('notesSection').style.display = 'none';
  document.getElementById('undetectedSection').style.display = 'none';
}

function loadExample() {
  const example = `1. PRAMES A x1 = ¬•25
2. AYAM GORENG x1 = ¬•15
3. BAKWAN 3PCS (5 PACK = 15 PCS) x5 = ¬•25
4. PARABO x2 = ¬•46
5. AYAM GORENG x1 = ¬•15
6. TELUR BALADO x1 = ¬•10
7. PARACU x1 = ¬•25
8. PRAMES A x1 = ¬•25
9. KENTANG BALADO x2 = ¬•20`;

  document.getElementById('orderInput').value = example;
  showAlert('‚ú® Contoh dimuat! Perhatikan PRAMES A & AYAM akan di-merge!', 'info');
}

window.addEventListener('DOMContentLoaded', () => {
  loadState();
});
</script>
</body>
</html>
